name: Lighthouse Performance Test

on:
  workflow_dispatch:

jobs:
  lighthouse-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g http-server lighthouse csv-writer

      - name: Start local server
        run: |
          mkdir -p logs reports
          npx http-server -p 8080 &
          echo "ðŸŒ Starting local server on port 8080..."
          sleep 5

      - name: Run Lighthouse Audit
        run: |
          echo "ðŸš€ Running Lighthouse Performance Test..."
          lighthouse http://127.0.0.1:8080/index.html \
            --output json \
            --output html \
            --output-path ./reports/lighthouse-report \
            --chrome-flags="--headless --no-sandbox --disable-gpu" \
            --only-categories=performance \
            | tee ./logs/lighthouse-console.log

      - name: Convert JSON report to CSV
        run: |
          echo "ðŸ“Š Converting Lighthouse JSON to CSV..."
          node -e "
          const fs = require('fs');
          const data = JSON.parse(fs.readFileSync('./reports/lighthouse-report.report.json', 'utf8'));
          const score = data.categories.performance.score * 100;
          const audits = Object.values(data.audits).map(a => ({
            id: a.id,
            title: a.title,
            score: a.score,
            numericValue: a.numericValue,
            displayValue: a.displayValue
          }));
          const rows = ['id,title,score,numericValue,displayValue'];
          audits.forEach(a=>{
            rows.push([a.id, JSON.stringify(a.title), a.score, a.numericValue, JSON.stringify(a.displayValue)].join(','));
          });
          rows.push(['performance_score', '', score, '', '']);
          fs.writeFileSync('./reports/lighthouse-report.csv', rows.join('\\n'));
          console.log('âœ… CSV report created: ./reports/lighthouse-report.csv');
          "

      - name: Upload Reports and Logs
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-performance-results
          path: |
            logs/
            reports/
